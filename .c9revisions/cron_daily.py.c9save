{"ts":1352618203889,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"import os, sys, random, string, datetime, time\nfrom sqlobject import *\nfrom database import *\nimport i18n\nimport smtplib\nfrom email.mime.text import MIMEText\nfrom email.Header import Header\nos.environ['TZ'] = 'America/Toronto'\ntime.tzset()\n\nif len(sys.argv) > 1:\n\treal = True\nelse:\n\treal = False\nfrom database import *\nfrom ops import *\n\ns = smtplib.SMTP_SSL('localhost',465)\ns.login('hvsi@hvsi.ca',\"HvsI_email_sender\")\n\nbot = Player.from_username('military.militaire')\ntoday = datetime.datetime.now()\neight30 = datetime.datetime(today.year, today.month, today.day, 8, 00, 0, 0)\nfour30 = datetime.datetime(today.year, today.month, today.day, 23, 55, 00, 0)\n\nmonday = datetime.datetime(Game.game_start.year, Game.game_start.month, Game.game_start.day, 12, 30, 0, 0)\ntuesday = datetime.datetime(Game.game_start.year, Game.game_start.month, Game.game_start.day+1, 12, 30, 0, 0)\ntuesday_four30 = datetime.datetime(Game.game_start.year, Game.game_start.month, Game.game_start.day+1, 22, 30, 0, 0)\ndef inform_player(players):\n\tsubject = i18n.i18n['e']['email']['subject'] + '/' + i18n.i18n['f']['email']['subject']\n\tsubject = Header(unicode(subject), 'utf-8')\n\tbody = i18n.i18n['e']['email']['message'] + '\\n\\n\\n' + i18n.i18n['f']['email']['message']\n\tmsg = MIMEText(body.encode('utf-8'), 'plain', 'utf-8')\n\tmsg['From'] = 'tag@hvsi.ca'\n\tmsg['Subject'] = subject\n\tif real:\n\t\ts.sendmail(msg['From'], [x.email for x in players], msg.as_string())\ndef check_player(player):\n\tuid = \"bot_\" + ''.join(random.sample(string.ascii_letters+string.digits, 36))\n\t# today's checkins < 2\n\ttodays = player.checkins.filter(AND(Checkin.q.time <= four30,Checkin.q.time >= eight30))\n\tprint 'Checking %s, checkins today: %i' % (player.username, todays.count())\n\tif todays.count() < 2:\n\t\tif todays.count() > 0:\n\t\t\tfor i in todays:\n\t\t\t\tprint '\t' + i.time.strftime('%b %d @ %H:%M')\n\t\tif today <= tuesday_four30:\n\t\t\tif player.signedin_time:\n\t\t\t\tprint '\tSignedin:' + player.signedin_time.strftime('%b %d @ %H:%M')\n\t\t\tif player.signedin and player.signedin_time and player.signedin_time.date() == monday.date():\n\t\t\t\tif player.signedin_time > monday:\n\t\t\t\t\treturn False\n\t\t\telif player.signedin and player.signedin_time and player.signedin_time.date() == tuesday.date():\n\t\t\t\tif player.signedin_time > tuesday:\n\t\t\t\t\treturn False\n\t\telif player.signedin and not player.signedin_time:\n\t\t\treturn False\n\t\tprint \"killing \" + player.username + ', with checkin count ' + str(todays.count())\n\t\tfor i in player.checkins:\n\t\t\tprint '\tcheckin:' + i.time.isoformat()\n\t\tfor i in player.kills:\n\t\t\tprint ' killed %s @ %s' % (i.taggee.username, time.isoformat())\n\t\tif real:\n\t\t\tadd_kill(bot, player, uid, override=True)\n\t\treturn player\n\t\t\nif __name__ == '__main__':\n\tplayers = Player.humans\n\tinforms = [x for x in [check_player(y) for y in players] if x]\n\tinform_player(informs)\ns.quit()\n"]],"start1":0,"start2":0,"length1":0,"length2":2831}]],"length":2831}
